闭包

> **Function Value**
>
> Go中函数是头等对象。可以作为参数传递， 也可以作为函数返回值，也可以绑定变量。
>
> function value本质上是一个指针，指向一个runtime.funcval结构体，这个结构体里只有一个地址，即这个函数指令的入口地址。（原因：处理闭包的情况！！！）
>
> ![](.assets/funcval.PNG)
>
> 
>
> **闭包**
>
> //https://www.cnblogs.com/cxying93/p/6103375.html
>
> 两个要点：
>
> 1. 包含在函数外部定义但在函数内被引用的自由变量
> 2. 脱离捕捉时的上下文， 也能照常运行
>
> 闭包对象在执行时创建。
>
> 
>
> ![](.assets/%E6%8D%95%E8%8E%B7%E5%8F%98%E9%87%8F.PNG)
>
> 通过特殊寄存器保存的funcval地址与偏移量获取被捕获的变量
>
> 某种角度上，闭包就有含有捕获列表的funcval。
>
> 被捕获变量除赋值外未被修改， 直接拷贝值即可。
>
> **局部变量堆分配也是一种变量逃逸**
>
> ![](.assets/%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F%E5%A0%86%E5%88%86%E9%85%8D.PNG)
>
> 被捕获变量为参数情况
>
> ![](.assets/%E4%BF%9D%E6%8C%81%E5%86%85%E5%A4%96%E5%8F%98%E9%87%8F%E4%B8%80%E8%87%B4.PNG)
>
> 

